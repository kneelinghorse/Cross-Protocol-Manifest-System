# npm Publishing Runbook (Mission B4.3)

This document captures the end-to-end workflow for releasing the Cross-Protocol Manifest System packages under the `@proto` scope. Ownership for the npm organization belongs to **@kneelinghorse** – the steps below highlight where human coordination is required.

## 1. Prerequisites

1. **npm Organization**
   - Create the `@proto` org on npm (`https://www.npmjs.com/org/proto`).
   - Add the CI user/bot plus @kneelinghorse as maintainers for each package.
2. **Automation Token**
   - Generate an npm access token with **automation** permissions.
   - Store it as `NPM_TOKEN` in the GitHub repository secrets.
3. **GitHub Actions Secrets**
   - `NPM_TOKEN` – automation token (scope: publish).
   - `GH_PAT_RELEASE` *(optional)* – if you want release PR comments from a bot (otherwise defaults to `GITHUB_TOKEN`).
4. **Local Tooling**
   - Node.js ≥ 20 (matches engines field).
   - pnpm ≥ 9.12.0 (`corepack enable` is recommended).

## 2. Workspace commands

```bash
# Install deps (cleans pre-existing node_modules)
pnpm install

# Build everything (tsup via turbo pipeline)
pnpm build

# Root tests (node --test suite)
pnpm test

# Package-level tests (if/when added)
pnpm test:workspace

# Start a new release entry
pnpm changeset
```

## 3. Release flow

1. **Create a changeset**
   - Run `pnpm changeset`.
   - Select the affected `@proto/*` packages and bump type (patch/minor/major).
   - Commit the file under `.changeset/`.
2. **Open a Release PR**
   - Push to `main`. The `Release Packages` workflow inspects pending changesets.
   - If changes exist, it opens/updates the `Release` PR (via `changesets/action`).
3. **Review + Merge**
   - Ensure CI passes: audit, root tests, workspace tests, builds.
   - Merge the Release PR once approvals complete.
4. **Publish**
   - On merge to `main`, the workflow runs `pnpm release` (aka `pnpm changeset publish`).
   - Packages are tagged and published with `access: public`.

> **Manual fallback:** you can run the following locally if a hotfix is required:
> ```bash
> pnpm install
> pnpm build
> pnpm changeset publish
> ```

## 4. Secrets & Registry configuration

GitHub Actions automatically writes `//registry.npmjs.org/:_authToken=${NPM_TOKEN}` to `~/.npmrc` before publishing. No `.npmrc` is committed to the repository to avoid accidental token leaks.

## 5. Verification checklist

After CI publishes the packages:

1. **Registry visibility**
   - `npm view @proto/core version`
   - `npm view @proto/data version`
   - ...repeat for event, api, agent, semantic, catalog, cli.
2. **Fresh install smoke test**
   ```bash
   rm -rf /tmp/proto-test && mkdir -p /tmp/proto-test
   cd /tmp/proto-test
   npm init -y
   npm install @proto/core @proto/data
   node -e "const { createDataProtocol } = require('@proto/data'); console.log(!!createDataProtocol);"
   ```
3. **CLI test**
   ```bash
   npm install -g @proto/cli
   proto validate --help
   proto diff --help
   ```
4. **Security audit**
   - `npm audit --production` (should match the workflow results).

## 6. Rollback plan

If a publish fails or a bad version slips out:

1. `npm unpublish @proto/<pkg>@<version> --force` (only within 24 hours).
2. Fix the issue locally, bump the patch version via `pnpm changeset`.
3. Run `pnpm version-packages` + `pnpm release` (or let CI handle it) to republish.

## 7. Coordination notes

- The automation token must be generated by @kneelinghorse (npm owner).
- Pause the workflow if org creation or token provisioning is still pending.
- Document any manual tweaks or emergency actions in `MASTER_CONTEXT` via the CMOS workflow after the publish.
